# Udev

[Udev规则编写教程网址](http://www.reactivated.net/writing_udev_rules.html)

## 0 概念

`/dev`: 设备节点目录，系统识别的硬件将会在该目录中创建设备节点。

`devfs`: 设备文件系统，用于管理设备

+ 其仅使用存在于`/dev`中的设备节点
+ 系统存在问题不容易修复

`sysfs`: 2.6 内核的文件系统。由内核管理，并提供当前插入系统的设备的相关基本信息

`udev`: 管理`/dev`目录的新方法。

+ 根据系统中存在的设备，在`/dev`中创建和命名设备节点
+ 对一个设备创建一个真实的设备节点
+ 将 **`sysfs`提供的信息** 与 **用户提供规则** 相匹配

## 1 Udev规则目录

Udev规则存储在下述两个目录中：

1. 系统级别：`/etc/udev/rules.d/`
2. 用户级别：`/lib/udev/rules.d/`

> 系统级别优先级更高。也就是说，如果`/etc`和`/usr/lib`中有同名文件，则`/etc`中文件优先。
>

## 2 Udev文件

Udev文件:

+ 必须有`.rules`后缀
+ 默认规则：`/etc/udev/rules.d/50-udev. rules`
+ 默认在`rules.d`文件夹中按照词法顺序解析文件
+ 如果希望自己的规则在默认规则前被解析，则应该将规则写入`/etc/udev/rules.d/10-local.rules`文件中

## 3 Udev规则语法

Udev规则中只包含两种类型的行：

1. 注释：以`#`开头的行
2. 规则：每个非空行是一条规则

> 每一行都被视为一条规则。因此，**规则不能跨行，且不支持任何形式的行延续**。换句话说，跨行的规则，或者行内有换行符的规则，都将被视为多条规则。

规则由通过**逗号**连接的**键值对**组合而成

其中，键值对分为两类：

+ **匹配键**：
  + 作用：匹配设备
  + 通过`==`连接键值
+ **赋值键**：
  + 定义操作，包括且不限于对匹配到的设备命名等
  + 通过如`=`或`+=`等赋值符号连接键值

每条规则至少包含一个匹配键和一个赋值键。当所有匹配键匹配到对应设备后，将调用定义好的赋值键对设备进行操作

例子：

```vi
    KERNEL=="hdb",NAME="my_spare_disk"
```

+ 上述规则包含两个键值对，两个键值对之间以`,`分割
+ 第一句键值对为匹配键值对，其中`KERNEL`属于匹配键，键与值之间由`==`连接
+ 第二句键值对为赋值键值对，其中`NAME`属于赋值键，键与值之间由`=`连接
+ 该规则的作用为：
  + 匹配一个内核名为`hdb`的设备，并将其名称修改为`my_spare_disk`
  + 该设备节点显示在`/dev/my_spare_disk`

## 4 匹配键

常用匹配键：

+ `KERNEL`: 设备内核名称
+ `SUBSYSTEM`: 设备子系统
+ `DRIVER`: 支持设备的驱动名称

匹配符：

+ `==`

## 5 赋值键

常用赋值键：

+ `NAME`: 设备节点名称
+ `SYMLINK`: 设备节点替代名称的符号链接表

赋值符：

+ `=`: 为设备设备节点名称，与`NAME`一同使用。
+ `+=`：为设备追加备用名称，与`SYMLINK`一同使用。

> 1. 一个设备仅能创建一个设备节点，通过`NAME=`设置。
> 2. 其他备用名，通过`SYMLINK+=`添加到符号链接表中，值通过`spcae`分割。
> 3. 没有通过`NAME`指定设备节点名称的话，设备节点名称为默认名称。

例子：

```vi
KERNEL=="hdc", SYMLINK+="cdrom cdrom0"
```

+ 匹配一个内核名为`hdb`的设备，并为其提供两个名称`cdrom`、`cdrom0`。
+ 由于没有通过`NAME`为`hdb`设置节点名称，因此，该设备节点显示在`/dev/hdb`中。
+ `SYMLINK+="cdrom cdrom0"`命令的本质上是创建了`/dev/cdrom`和`/dev/cdrom0`两个节点链接，且两个节点链接都指向`/dev/hdb`。

## 6 sysfs属性匹配

可以通过匹配键`ATTR`，进一步通过`sysfs`提供的属性（如供应商代码、确切的产品编号、序列号、存储容量、分区数量等）对设备进行匹配

例子：

```vi
SUBSYSTEM=="block", ATTR{size}=="234441648", SYMLINK+="my_disk"
```

## 7 设备树

设备以**树**的层次结构形式表示。因此，设备之间具有**父子关系**。

如，SCSI磁盘设备是串行ATA控制器设备的子设备，串行ATA控制器设备又是PCI总线设备的子设备。

存在一种情况为，某一种设备信息并未暴露，而其父设备暴露。这种情况，匹配该设备的方法则需要通过`sysfs`提供的其父设备信息进行匹配。

四种**沿着设备树向上匹配**的匹配键：

+ `KERNELS`: 匹配设备以及其任何父设备的内核名称
+ `SUBSYSTEMS`: 匹配设备子系统以及其任何父设备的子系统
+ `DRIVERS`: 匹配支持设备的驱动名称以及支持任何父设备的驱动名称
+ `ATTRS`: 匹配设备的sysfs属性或任何父设备的sysfs属性
